[{"id":"bd4b401b.10ecb","type":"tab","label":"플로우 1","disabled":false,"info":""},{"id":"7749bfd.b017f4","type":"tcp in","z":"bd4b401b.10ecb","name":"","server":"server","host":"","port":"60000","datamode":"stream","datatype":"utf8","newline":"\\n","topic":"","base64":false,"x":100,"y":620,"wires":[["e1f1712c.1a5e3","5ddcb5ec.7ebcdc"]]},{"id":"af15362a.a64c68","type":"tcp out","z":"bd4b401b.10ecb","host":"","port":"","beserver":"reply","base64":false,"end":false,"name":"","x":430,"y":580,"wires":[]},{"id":"db1a5ae7.1c2bf8","type":"function","z":"bd4b401b.10ecb","name":"메시지에코","func":"msg.payload = \"[서버응답]\" + msg.payload + \"\\n\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":540,"wires":[[]]},{"id":"e1f1712c.1a5e3","type":"function","z":"bd4b401b.10ecb","name":"클라언트등록","func":"if(msg.payload[0] == '#'){\n   //디바이스 아이디인것이다!\n   //등록을 해야한다!\n   //#OK를 응답한다!\n   msg.payload = msg.payload.replace(\"\\r\",\"\");\n   msg.payload = msg.payload.replace(\"\\n\",\"\");\n  //msg.payload = 디바이스ID\n  //msg = 디바이스의 소켓\n   //클라이언트 목록 오브젝트를 가져온다\n   var clients = global.get(\"clients\");\n\n   //혹시~~전역변수 목록이 생성이 안되어 있으면 내가 생성한다!\n   if(clients == null) global.set(\"clients\",{});\n\n   //무조건 전역변수 clients목록이 있는것이다!\n\n   //msg 오브젝트에 마지막데이터 수신시간 필드를 할당한다\n   msg.last_msg = new Date();\n   msg.send = 0;\n   msg.recv = 0;\n   msg.run = true;\n   msg.rssi = -90;\n\n   //전역변수 record_num의 값을 가지고 와서\n   //레코드번호를 할당하고 번호를 1개씩 올린다\n   var record_num = global.get(\"record_num\");\n   var record_list = global.get(\"record_list\");\n\n   msg.record_num = record_num;\n   \n   record_list.push(record_num);\n   \n   record_num++;\n   global.set(\"record_num\",record_num);\n\n   clients[msg.payload] = msg;\n   \n   msg.payload = \"#OK\\n\";\n   return msg;\n}else{\n  return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":580,"wires":[["af15362a.a64c68"]]},{"id":"b2fbc64.7de6038","type":"debug","z":"bd4b401b.10ecb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":650,"y":1260,"wires":[]},{"id":"18e8ebe5.53be94","type":"status","z":"bd4b401b.10ecb","name":"","scope":["7749bfd.b017f4"],"x":160,"y":1040,"wires":[["43db42a0.f45e3c"]]},{"id":"43db42a0.f45e3c","type":"function","z":"bd4b401b.10ecb","name":"클라이언트가끊어지는부분","func":"if(msg.status.event != \"disconnect\") return null;\n\n//클라이언트 목록을 가져온다!\nvar clients = global.get(\"clients\"); //딕셔너리\nvar list = Object.keys(clients);\n\n//msg.ip  msg.port\n//msg.status.event (connect,disconnect)\n//msg.status.ip\n//msg.status.port\n\n//현재 끊어지는 소켓정보하고 등록된 정보하고 같은게 있다면 그녀석을 삭제하겠다!\nfor(var i = 0;i<list.length;i++){\n    //list[i] : i번째 디바이스의 이름\n    //clients : 디바이스의 딕셔너리\n    var socket = clients[list[i]];\n    if(socket != null){\n        if(socket.ip == msg.status.ip && socket.port == msg.status.port){\n            //디바이스목록에서 삭제해라\n            //global.set(list[i],undefined);\n            delete clients[list[i]];\n            break;\n        }\n    }\n}\n\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":1100,"wires":[[]]},{"id":"3a6650c3.7141c","type":"inject","z":"bd4b401b.10ecb","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":160,"y":1200,"wires":[["19b300c1.02a9df"]]},{"id":"19b300c1.02a9df","type":"function","z":"bd4b401b.10ecb","name":"","func":"var list = global.keys();\n\nfor(var i = 0;i<list.length;i++){\n    global.set(list[i],undefined);\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":1200,"wires":[[]]},{"id":"29346016.990f9","type":"inject","z":"bd4b401b.10ecb","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"1","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":170,"y":900,"wires":[["3eb99c1d.3f0f64","5211fb6f.736544"]]},{"id":"3eb99c1d.3f0f64","type":"function","z":"bd4b401b.10ecb","name":"클라이언트목록조회","func":"var clients = global.get(\"clients\");\nvar dic = Object.keys(clients);\n\n//클라이언트들의 목록을 가지고 온다!\nvar list = []; //list UI에 반환해야할 변수\nvar now = new Date();\n\nfor(var i = 0;i<dic.length;i++){\n  //dic[i] : i번째 클라이언트의 ID\n  //clients[dic[i]] : i번째 클라이언트의 소켓\n  var socket = clients[dic[i]];\n\n  var timeout = now  - socket.last_msg;\n\n  if(timeout > 5000){\n      //클라이언트 비활성상태\n      list.push(\"<img src=/link2.png width=30 height=30> <font color=red>\"+dic[i]+\"[▲\"+socket.send+\"/▼\"+socket.recv+\"]</font>\");\n      socket.run = false;\n  }else{\n      //활성~!\n      list.push(\"<img src=/link1.png width=30 height=30> <font color=black>\"+dic[i]+\"[▲\"+socket.send+\"/▼\"+socket.recv+\"]</font>\");\n      socket.run = true;\n  }\n\n}\n\n\nmsg.payload = list; //list\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":900,"wires":[["968b3102.77025"]]},{"id":"968b3102.77025","type":"ui_list","z":"bd4b401b.10ecb","group":"aa2634f1.1bbfd8","name":"","order":1,"width":6,"height":5,"lineType":"two","actionType":"click","allowHTML":true,"outputs":1,"topic":"","x":570,"y":860,"wires":[["a829b812.0a7288"]]},{"id":"5ddcb5ec.7ebcdc","type":"function","z":"bd4b401b.10ecb","name":"일반메시지","func":"if(msg.payload[0] == '#') return null;\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":680,"wires":[["9059a8b6.8c3a18"]]},{"id":"9059a8b6.8c3a18","type":"json","z":"bd4b401b.10ecb","name":"","property":"payload","action":"","pretty":false,"x":410,"y":760,"wires":[["633aa55e.1c831c","b76ae294.4b317","200821e6.cd096e"]]},{"id":"633aa55e.1c831c","type":"function","z":"bd4b401b.10ecb","name":"받는소켓을찾는부분","func":"var clients = global.get(\"clients\");\n\n//받는놈의 id가 #server인경우를 별도로 뺸다\nif(msg.payload.to == \"#server\"){\n    //보내는놈의 소켓을 가지고 와서 마지막 데이터 수신시간을 기록한다!\n    //msg.payload.from\n    var sender_socket = clients[msg.payload.from];\n    \n    if(sender_socket != null){\n        //시간기록~!\n        sender_socket.last_msg = new Date();\n    }\n    msg.payload = msg.payload.msg.length;\n    \n    return [null,null];\n}\n\n//받는놈의 소켓을 가지고 오라\n\nvar socket = clients[msg.payload.to];\n\n//msg.payload.msg => 서버에서 보내줘야할 메시지\n\n\nif(socket != null && socket.run){\n    var myobject = {};\n    myobject.from = msg.payload.from;\n    myobject.msg = msg.payload.msg;\n\n    socket.payload = myobject;\n    socket.to = msg.payload.to;\n    socket.len = msg.payload.msg.length;\n    return [socket,msg];\n}else{\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":660,"wires":[["5d42a48e.36fc9c","eba4db91.daba58"],["8b16ee3d.e366"]]},{"id":"47e4a769.c7c1a8","type":"tcp out","z":"bd4b401b.10ecb","host":"","port":"","beserver":"reply","base64":false,"end":false,"name":"","x":910,"y":740,"wires":[]},{"id":"c1aa9bcb.276c68","type":"inject","z":"bd4b401b.10ecb","name":"전역변수설정","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":500,"wires":[["2378994b.4a5556"]]},{"id":"2378994b.4a5556","type":"function","z":"bd4b401b.10ecb","name":"전역변수설정","func":"\n//비어있는 클라이언트 목록을 생성\nvar clients = {};\nglobal.set(\"clients\",clients);\n//클라이언트들이 송신하는 데이터의 총량을 저장하는 변수\nvar upload = {};\nupload.byte = 0;\nglobal.set(\"upload\",upload);\n//클라이언트들이 수신하는 데이터의 총량을 저장하는 변수\nvar dnload = {};\ndnload.byte = 0;\nglobal.set(\"dnload\",dnload);\n\nvar runtime = {};\nruntime.time = new Date();\nglobal.set(\"runtime\",runtime);\n\nglobal.set(\"record_num\",0);\nglobal.set(\"record_list\",[])\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":500,"wires":[[]]},{"id":"15ffb5ef.458c5a","type":"inject","z":"bd4b401b.10ecb","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":160,"y":1260,"wires":[["bbb3591a.ad2a98"]]},{"id":"bbb3591a.ad2a98","type":"function","z":"bd4b401b.10ecb","name":"전역변수 목록을 가지고오는 블럭","func":"var list = global.keys();\n\n\nmsg.payload = list;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1260,"wires":[["b2fbc64.7de6038"]]},{"id":"2a250709.a954d8","type":"inject","z":"bd4b401b.10ecb","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":160,"y":1320,"wires":[["e9c390f0.c148b"]]},{"id":"e9c390f0.c148b","type":"function","z":"bd4b401b.10ecb","name":"#device1에 소켓 정보를 조회한다","func":"var clients = global.get(\"clients\");\n\nvar socket = clients[\"#device1\"];\n\nif(socket != null){\n    return socket;\n}else{\n    return null;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":1320,"wires":[["91c572a4.b543b"]]},{"id":"91c572a4.b543b","type":"debug","z":"bd4b401b.10ecb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":510,"y":1380,"wires":[]},{"id":"4ea4ae6d.f63b8","type":"function","z":"bd4b401b.10ecb","name":"전체upload량측정","func":"var upload = global.get(\"upload\");\n//upload.byte\n\nvar len = msg.payload.msg.length;\n\nupload.byte += len;\n\nmsg.payload = upload.byte;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1030,"y":660,"wires":[[]]},{"id":"872388b0.fd5428","type":"function","z":"bd4b401b.10ecb","name":"전체dnload량측정","func":"var upload = global.get(\"dnload\");\n\n//msg.len => 유효한 메시지의 길이\n\nupload.byte += msg.payload.msg.length;\n\nmsg.payload = upload.byte;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":780,"wires":[[]]},{"id":"4a563708.589438","type":"ui_text","z":"bd4b401b.10ecb","group":"9c2bb4e6.01d708","order":1,"width":0,"height":0,"name":"","label":"서버에들어오는데이터총량(byte)","format":"{{msg.byte}}","layout":"row-spread","className":"","x":660,"y":940,"wires":[]},{"id":"a82d96cb.087208","type":"ui_text","z":"bd4b401b.10ecb","group":"9c2bb4e6.01d708","order":2,"width":0,"height":0,"name":"","label":"서버에서나가는데이터총량(byte)","format":"{{msg.byte}}","layout":"row-spread","className":"","x":660,"y":980,"wires":[]},{"id":"cb75ae52.51876","type":"inject","z":"bd4b401b.10ecb","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":1440,"wires":[["65730c0c.f09704"]]},{"id":"65730c0c.f09704","type":"function","z":"bd4b401b.10ecb","name":"#device1청소부!","func":"var clients = global.get(\"clients\");\nvar socket = clients[\"#device1\"];\n\nvar timeout = new Date() - socket.last_msg;\n\nif(timeout > 5000){\n    //클라이언트 비활성상태\n    msg.payload = \"클라이언트 비활성!\";\n}else{\n    //활성~!\n    msg.payload = \"클라이언트 활성!\";\n}\n\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":1440,"wires":[["80003e5c.8d95f"]]},{"id":"80003e5c.8d95f","type":"debug","z":"bd4b401b.10ecb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":530,"y":1440,"wires":[]},{"id":"5211fb6f.736544","type":"function","z":"bd4b401b.10ecb","name":"서버상태업데이트","func":"var upload = global.get(\"upload\");\nvar dnload = global.get(\"dnload\");\nvar runtime = global.get(\"runtime\");\n\nvar now = new Date();\nvar time = now - runtime.time;\ntime = time/1000;\n\nmsg.time = time;\nmsg.now = now.toString();\n\nreturn [upload,dnload,msg];","outputs":3,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":960,"wires":[["4a563708.589438"],["a82d96cb.087208"],["1f2de8f5.73aab7","b2ef91d.47eb07"]]},{"id":"ff4e685a.c03a78","type":"function","z":"bd4b401b.10ecb","name":"디바이스별로 송신데이터를 체크","func":"var clients = global.get(\"clients\");\n\nif(msg.payload.to == \"#server\") return null;\n\nvar socket = clients[msg.payload.from];\n\nif(socket == null) return null;\n\nsocket.send += msg.payload.msg.length;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":420,"wires":[[]]},{"id":"9a2ade6f.500cb","type":"function","z":"bd4b401b.10ecb","name":"디바이스별dnload량측정","func":"var clients = global.get(\"clients\");\n//msg.len = 메시지의길이\n//msg.to = 받는놈의 ID\nvar socket = clients[msg.to];\n\nif(socket == null) return null;\n\nsocket.recv += msg.payload.msg.length;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":820,"wires":[[]]},{"id":"1f2de8f5.73aab7","type":"ui_text","z":"bd4b401b.10ecb","group":"9c2bb4e6.01d708","order":3,"width":0,"height":0,"name":"","label":"서버작동시간(초)","format":"{{msg.time}}","layout":"row-spread","className":"","x":610,"y":1020,"wires":[]},{"id":"b2ef91d.47eb07","type":"ui_text","z":"bd4b401b.10ecb","group":"9c2bb4e6.01d708","order":4,"width":0,"height":0,"name":"","label":"서버의 현재시간","format":"{{msg.now}}","layout":"row-spread","className":"","x":600,"y":1060,"wires":[]},{"id":"abde5f80.0eaac","type":"ui_text","z":"bd4b401b.10ecb","group":"4ac94e5d.efbcd","order":1,"width":0,"height":0,"name":"","label":"IP주소","format":"{{msg.ip}}","layout":"row-spread","className":"","x":1090,"y":800,"wires":[]},{"id":"a829b812.0a7288","type":"function","z":"bd4b401b.10ecb","name":"클라이언트ID분리기+소켓정보반환","func":"var clients = global.get(\"clients\");\n\nvar data = msg.payload.title;\nvar start = data.indexOf(\">#\")+1;\nvar end = data.indexOf(\"[▲\");\nvar id = data.substring(start,end);\n\nvar socket = clients[id];\n\nif(socket == null) return null;\n\n\n\nreturn socket;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":860,"wires":[["abde5f80.0eaac","7945b4f5.eb5edc","1befdd95.eb83d2","1d34c500.2004cb","dc8727b4.dbf438"]]},{"id":"7945b4f5.eb5edc","type":"ui_text","z":"bd4b401b.10ecb","group":"4ac94e5d.efbcd","order":2,"width":0,"height":0,"name":"","label":"포트번호","format":"{{msg.port}}","layout":"row-spread","className":"","x":1100,"y":840,"wires":[]},{"id":"1befdd95.eb83d2","type":"ui_text","z":"bd4b401b.10ecb","group":"4ac94e5d.efbcd","order":3,"width":0,"height":0,"name":"","label":"마지막메시지수신시간","format":"{{msg.last_msg}}","layout":"row-spread","className":"","x":1140,"y":880,"wires":[]},{"id":"1d34c500.2004cb","type":"ui_text","z":"bd4b401b.10ecb","group":"4ac94e5d.efbcd","order":4,"width":0,"height":0,"name":"","label":"세션타입","format":"{{msg._session.type}}","layout":"row-spread","className":"","x":1100,"y":920,"wires":[]},{"id":"dc8727b4.dbf438","type":"ui_text","z":"bd4b401b.10ecb","group":"4ac94e5d.efbcd","order":5,"width":0,"height":0,"name":"","label":"세션아이디","format":"{{msg._session.id}}","layout":"row-spread","className":"","x":1110,"y":960,"wires":[]},{"id":"78842f72.f6d57","type":"inject","z":"bd4b401b.10ecb","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":160,"y":1520,"wires":[["a544b802.ea80f8"]]},{"id":"a544b802.ea80f8","type":"function","z":"bd4b401b.10ecb","name":"전체 클라이언트 목록 가지고오기!","func":"var clients = global.get(\"clients\");\n\nvar dic = Object.keys(clients);\n\nvar list = [];\n\nfor(var i = 0;i<dic.length;i++){\n    list.push(dic[i]);\n}\n\nmsg.payload = list;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1520,"wires":[["becc0ec6.5b22e"]]},{"id":"becc0ec6.5b22e","type":"debug","z":"bd4b401b.10ecb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":670,"y":1520,"wires":[]},{"id":"5d42a48e.36fc9c","type":"json","z":"bd4b401b.10ecb","name":"","property":"payload","action":"","pretty":false,"x":590,"y":760,"wires":[["7e05413b.993"]]},{"id":"7e05413b.993","type":"function","z":"bd4b401b.10ecb","name":"\\n","func":"msg.payload = msg.payload+\"\\n\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":740,"wires":[["47e4a769.c7c1a8"]]},{"id":"eba4db91.daba58","type":"json","z":"bd4b401b.10ecb","name":"","property":"payload.msg","action":"","pretty":false,"x":590,"y":800,"wires":[["872388b0.fd5428","9a2ade6f.500cb"]]},{"id":"8b16ee3d.e366","type":"json","z":"bd4b401b.10ecb","name":"","property":"payload.msg","action":"","pretty":false,"x":870,"y":640,"wires":[["4ea4ae6d.f63b8"]]},{"id":"767d3c2e.27f6b4","type":"json","z":"bd4b401b.10ecb","name":"","property":"payload.msg","action":"","pretty":false,"x":600,"y":420,"wires":[["ff4e685a.c03a78"]]},{"id":"b76ae294.4b317","type":"function","z":"bd4b401b.10ecb","name":"","func":"if(msg.payload.to == \"#server\") return null;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":540,"wires":[["767d3c2e.27f6b4","ff95527d.06437"]]},{"id":"ff95527d.06437","type":"function","z":"bd4b401b.10ecb","name":"전역변수에 디바이스별 데이터를 기록한다","func":"//table에 하나의 레코드를 입력하거나 수정하는 쿼리로 변경한다!\n//전역변수에서 해당되는 클라이언트의 소켓을 가지고온다\nvar clients = global.get(\"clients\"); //딕셔너리 구조임\n//해당되는 클라이언트의 소켓을 찾아내라\nvar socket = clients[msg.payload.from];\n//소켓이 없으면 아무일도 안함!\nif(socket == null) return;\n\n//반대쪽으로 넘길 table 입력값을 만들어준다!\nvar update = {};\nupdate.command = \"updateOrAddData\";\nupdate.arguments = [];\n\nvar argu = [];\nvar dataset = {};\ndataset.id = socket.record_num; //레코드넘버\ndataset.Device_id = msg.payload.from; \ndataset.Dong = msg.payload.dong;\ndataset.Rssi = socket.rssi; //wifi감도\ndataset.Run = socket.run?1:0; //활성상태\ndataset.Up = socket.send; //업로드데이터량\ndataset.Down = socket.recv; //다운로드데이터량\n\ndataset.Data = msg.payload.msg;\n//dataset.Data = [];\n\nargu.push(dataset);\nupdate.arguments.push(argu);\n\nmsg.payload = update;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":860,"y":500,"wires":[["541afce5.f7bed4"]]},{"id":"39a0f6e3.85239a","type":"inject","z":"bd4b401b.10ecb","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"str","x":1250,"y":440,"wires":[["1f1ff5b3.35447a"]]},{"id":"541afce5.f7bed4","type":"ui_table","z":"bd4b401b.10ecb","group":"832145a9.25bca8","name":"컨트롤패널","order":1,"width":25,"height":7,"columns":[],"outputs":1,"cts":true,"x":1290,"y":640,"wires":[["a0ff7cd5.14725"]]},{"id":"9ebf5dab.d6237","type":"function","z":"bd4b401b.10ecb","name":"클라이언트별 소켓에서 데이터를 뺴오는부분","func":"//전역변수에서 클라이언트 목록을 가지고 온다\nvar clients = global.get(\"clients\");\n\nvar dic = Object.keys(clients); //배열형태\n\n//출력 JSON\nvar client_list = [];\n\nfor(var i = 0;i<dic.length;i++){\n   var socket = clients[dic[i]];\n   var dataset = {};\n   dataset.Device_id = dic[i];\n   dataset.Rssi = socket.Rssi;\n   dataset.Run = socket.run?1:0;\n   dataset.Up = socket.send;\n   dataset.Down = socket.recv;\n   dataset.Cds = socket.dataset.Cds;\n   dataset.Led1 = socket.dataset.Led1;\n   dataset.Led2 = socket.dataset.Led2;\n   dataset.Led3 = socket.dataset.Led3;\n   dataset.Led4 = socket.dataset.Led4;\n\n   client_list.push(dataset);\n}\nmsg.payload = client_list;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":1660,"wires":[[]]},{"id":"a0ff7cd5.14725","type":"function","z":"bd4b401b.10ecb","name":"LED제어명령을 눌렀을때","func":"var clients = global.get(\"clients\");\n\nvar socket = clients[msg.payload.Device_id];\n\nif(socket == null) return;\n\nif(msg.topic == \"Led1\"){\n   //LED1 제어 신호를 해당되는 디바이스에게 전송한다\n   if(msg.payload.Led1 == 0){\n      //1을 보냄\n      socket.payload = \"{\\\"from\\\":\\\"#server\\\",\\\"msg\\\":{\\\"Led_num\\\":1,\\\"State\\\":1}}\\n\";\n   }else{\n      //0을보냄\n      socket.payload = \"{\\\"from\\\":\\\"#server\\\",\\\"msg\\\":{\\\"Led_num\\\":1,\\\"State\\\":0}}\\n\";\n   }\n\n   return socket;\n}else if(msg.topic == \"Led2\"){\n\n   if(msg.payload.Led2 == 0){\n      //1을 보냄\n      socket.payload = \"{\\\"from\\\":\\\"#server\\\",\\\"msg\\\":{\\\"Led_num\\\":2,\\\"State\\\":1}}\\n\";\n   }else{\n      //0을보냄\n      socket.payload = \"{\\\"from\\\":\\\"#server\\\",\\\"msg\\\":{\\\"Led_num\\\":2,\\\"State\\\":0}}\\n\";\n   }\n   return socket;\n}else if(msg.topic == \"Led3\"){\n\n   if(msg.payload.Led3 == 0){\n      //1을 보냄\n      socket.payload = \"{\\\"from\\\":\\\"#server\\\",\\\"msg\\\":{\\\"Led_num\\\":3,\\\"State\\\":1}}\\n\";\n   }else{\n      //0을보냄\n      socket.payload = \"{\\\"from\\\":\\\"#server\\\",\\\"msg\\\":{\\\"Led_num\\\":3,\\\"State\\\":0}}\\n\";\n   }\n   return socket;\n}else if(msg.topic == \"Led4\"){\n\n   if(msg.payload.Led4 == 0){\n      //1을 보냄\n      socket.payload = \"{\\\"from\\\":\\\"#server\\\",\\\"msg\\\":{\\\"Led_num\\\":4,\\\"State\\\":1}}\\n\";\n   }else{\n      //0을보냄\n      socket.payload = \"{\\\"from\\\":\\\"#server\\\",\\\"msg\\\":{\\\"Led_num\\\":4,\\\"State\\\":0}}\\n\";\n   }\n   return socket;\n}\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1510,"y":580,"wires":[["f6cb0591.1facb8"]]},{"id":"f6cb0591.1facb8","type":"tcp out","z":"bd4b401b.10ecb","host":"","port":"","beserver":"reply","base64":false,"end":false,"name":"","x":1510,"y":660,"wires":[]},{"id":"fdbfe957.19b678","type":"function","z":"bd4b401b.10ecb","name":"컨트롤패널오프라인체크","func":"//1번 전체 소켓을 가지고온다\n//로프를 회전을 하면서 오프인인 레코드의 정보를 업데이트한다\nvar clients = global.get(\"clients\");\n\nvar dic = Object.keys(clients);\n\nvar update = {};\nupdate.command = \"updateOrAddData\";\nupdate.arguments = [];\nvar argu = [];\n\nfor(var i = 0;i<dic.length;i++){\n    var socket = clients[dic[i]];\n\n    if(socket.run == false){\n        //비활성상태\n\tvar dataset = {};\n\tdataset.id = socket.record_num;\n\tdataset.Device_id = dic[i];\n\tdataset.Rssi = -90;\n\tdataset.Run = socket.run?1:0;\n\tdataset.Up = socket.send;\n\tdataset.Down = socket.recv;\n\tdataset.Cds = 0;\n\tdataset.Led1 = 0;\n\tdataset.Led2 = 0;\n\tdataset.Led3 = 0;\n\tdataset.Led4 = 0;\n              argu.push(dataset);\n    }\n}\nupdate.arguments.push(argu);\n\nif(argu.length == 0) return null;\n\nmsg.payload = update;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1450,"y":720,"wires":[["541afce5.f7bed4"]]},{"id":"352f847d.81aaec","type":"inject","z":"bd4b401b.10ecb","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"1","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"str","x":1230,"y":720,"wires":[["fdbfe957.19b678","e0b2f450.654778"]]},{"id":"e0b2f450.654778","type":"function","z":"bd4b401b.10ecb","name":"삭제할 레코드를 찾는 노드","func":"//클라이언트 정보를 가지고온다\nvar clients = global.get(\"clients\");\n//발급한 레코드 번호를 가지고온다\nvar record_list = global.get(\"record_list\");\n\n//클라이언트 정보에서 루프를 순회하면서 레코드번호를 뺀다\nvar socket_record_list = [];\n\nvar dic = Object.keys(clients);\n\nfor(var i = 0;i<dic.length;i++){\n    var socket = clients[dic[i]];\n    socket_record_list.push(socket.record_num);\n}\n\nvar is_found = true;\nvar is_run = false;\nvar delete_index = 0;\n//record_list : 전체 발급한 레코드번호(비어있는거 포함)\n//socket_record_list(실제 소켓이 할당받은 레코드번호)\nfor(var j = 0;j<record_list.length;j++){\n    for(var k = 0;k<socket_record_list.length;k++){\n        if(record_list[j] == socket_record_list[k]){\n            //실제 발급한 번호를 실사용하고있다!\n            is_found = false;\n            break;\n        }else{\n            //매치가 안되는 부분\n            is_found = true;\n        }\n    }\n\n    //단 한번도 실제 소켓에서 사용하는 번호와 만난적이 없음!\n    if(is_found == true){\n        delete_index = j;\n        is_run = true;\n        break;\n    }\n}\n\n\n\n//delete_index\nif(is_run){\n    //삭제하는 구문을 만든다음\n    msg.payload = {\n         command:\"deleteRow\",\n         arguments:[record_list[delete_index]]\n    }\n    //리스트에서 해당 요소를 삭제한다\n    record_list.splice(delete_index,1);\n\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1470,"y":780,"wires":[["541afce5.f7bed4"]]},{"id":"200821e6.cd096e","type":"function","z":"bd4b401b.10ecb","name":"서버에업로드되는WIFI감도를처리하는부분","func":"//클라이언트에서 접속확인용 메시지일때만~\nif(msg.payload.msg.Rssi == null) return;\n\n//소켓목록을 가지고온다\nvar clients = global.get(\"clients\"); \n\n//해당 클라이언트의 소켓을 찾는다\nvar socket = clients[msg.payload.from];\n\n//소켓이 없으면 아무일도 하지 않음\nif(socket == null) return null;\n\nsocket.rssi = msg.payload.msg.Rssi; //wifi감도\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":580,"wires":[[]]},{"id":"70cf99c8.19c538","type":"debug","z":"bd4b401b.10ecb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":810,"y":540,"wires":[]},{"id":"1f1ff5b3.35447a","type":"change","z":"bd4b401b.10ecb","name":"ui_control","rules":[{"t":"set","p":"ui_control","pt":"msg","to":"{\"tabulator\":{\"rowUpdated\":\"function(row){     row.getCells().forEach(cell => {        let oldValue = cell.getOldValue();        if (oldValue!== null && cell.getValue()!=oldValue){            let element = cell.getElement();            element.classList.remove(\\\"run-highlightUpdate\\\");            void element.offsetWidth;            element.classList.add(\\\"run-highlightUpdate\\\");        }});}\",\"groupBy\":\"Dong\",\"columns\":[{\"formatterParams\":{\"target\":\"_blank\"},\"title\":\"디바이스ID\",\"field\":\"Device_id\",\"width\":100,\"align\":\"center\"},{\"formatterParams\":{\"target\":\"_blank\"},\"title\":\"하우스번호\",\"field\":\"Dong\",\"width\":100,\"align\":\"center\"},{\"formatterParams\":{\"target\":\"_blank\",\"min\":-90,\"max\":-50,\"color\":[\"red\",\"orange\",\"green\"],\"legend\":\"function (value) {return '&nbsp;&nbsp;'+value+'dBm';}\",\"legendColor\":\"#101010\",\"legendAlign\":\"left\"},\"title\":\"WiFi감도\",\"field\":\"Rssi\",\"formatter\":\"progress\",\"width\":100},{\"formatterParams\":{\"target\":\"_blank\"},\"title\":\"활성상태\",\"field\":\"Run\",\"formatter\":\"function(cell, formatterParams, onRendered){if(cell.getValue() == 0) return '<i class=\\\"fa fa-ban fa-lg\\\"></i>';else return '<i class=\\\"fa fa-check-circle fa-lg\\\"></i>';}\",\"width\":100,\"align\":\"center\"},{\"formatterParams\":{\"target\":\"_blank\"},\"title\":\"업로드량\",\"field\":\"Up\",\"formatter\":\"function(cell, formatterParams, onRendered){return cell.getValue()+'bytes';}\",\"width\":100,\"align\":\"center\"},{\"formatterParams\":{\"target\":\"_blank\"},\"title\":\"다운로드량\",\"field\":\"Down\",\"formatter\":\"function(cell, formatterParams, onRendered){return cell.getValue()+'bytes';}\",\"width\":100,\"align\":\"center\"},{\"formatterParams\":{\"target\":\"_blank\"},\"title\":\"다바이스별 파라미터\",\"field\":\"Data\",\"width\":600,\"formatter\":\"function(cell, formatterParams, onRendered){   var html = '';    for(var i =0;i<cell.getValue().length;i++){        if(cell.getValue()[i].Type == \\\"sw\\\"){             html += '<i class=\\\\\\\"fa fa-toggle-on\\\\\\\"></i>'+cell.getValue()[i].Name + '(' + cell.getValue()[i].Value + ') ';        }else if(cell.getValue()[i].Type == \\\"sensor\\\"){             html += '<i class=\\\\\\\"fa fa-cog\\\\\\\"></i>'+cell.getValue()[i].Name + '(' + cell.getValue()[i].Value + ') ';        }else{             html += '<i class=\\\\\\\"fa fa-tag\\\\\\\"></i>'+cell.getValue()[i].Name + '(' + cell.getValue()[i].Value + ') ';        }         }   return html;}\"}]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1300,"y":520,"wires":[["541afce5.f7bed4"]]},{"id":"1eec6083.8f863f","type":"ui_template","z":"bd4b401b.10ecb","group":"832145a9.25bca8","name":"헤드섹션","order":2,"width":0,"height":0,"format":"<style>\n    @keyframes highlightUpdate {\n      from {background-color: #ffff00ff;}\n      to {background-color: #ffff0000;}\n    }\n    .run-highlightUpdate {\n        animation: highlightUpdate 2s ease;\n    }\n</style>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"global","className":"","x":1420,"y":340,"wires":[[]]},{"id":"6642203.51825e","type":"function","z":"bd4b401b.10ecb","name":"끄는거","func":"var clients = global.get(\"clients\");\n\nvar socket = clients[\"#device3\"];\n\nif(socket == null) return;\n\n\nsocket.payload = \"{\\\"from\\\":\\\"#server\\\",\\\"msg\\\":[{\\\"Type\\\":\\\"sw\\\",\\\"Name\\\":\\\"pump\\\",\\\"Value\\\":0}]}\\n\";\n\nreturn socket;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1170,"y":1060,"wires":[["243bb6a4.d497ca"]]},{"id":"98288f2a.1d46e","type":"function","z":"bd4b401b.10ecb","name":"켜는거","func":"var clients = global.get(\"clients\");\n\nvar socket = clients[\"#device3\"];\n\nif(socket == null) return;\n\n\nsocket.payload = \"{\\\"from\\\":\\\"#server\\\",\\\"msg\\\":[{\\\"Type\\\":\\\"sw\\\",\\\"Name\\\":\\\"pump\\\",\\\"Value\\\":1}]}\\n\";\n\nreturn socket;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1170,"y":1120,"wires":[["243bb6a4.d497ca"]]},{"id":"243bb6a4.d497ca","type":"tcp out","z":"bd4b401b.10ecb","host":"","port":"","beserver":"reply","base64":false,"end":false,"name":"","x":1340,"y":1060,"wires":[]},{"id":"81e16c4c.fd35d","type":"function","z":"bd4b401b.10ecb","name":"유량초기화","func":"var clients = global.get(\"clients\");\n\nvar socket = clients[\"#device3\"];\n\nif(socket == null) return;\n\n\nsocket.payload = \"{\\\"from\\\":\\\"#server\\\",\\\"msg\\\":[{\\\"Type\\\":\\\"sw\\\",\\\"Name\\\":\\\"flow\\\",\\\"Value\\\":1}]}\\n\";\n\nreturn socket;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1190,"y":1180,"wires":[["243bb6a4.d497ca"]]},{"id":"1dca979e.426958","type":"ui_button","z":"bd4b401b.10ecb","name":"","group":"1c2f0814.027af8","order":2,"width":0,"height":0,"passthru":false,"label":"펌프멈춤","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"topic","topicType":"msg","x":1010,"y":1060,"wires":[["6642203.51825e"]]},{"id":"18745c65.a9a234","type":"ui_button","z":"bd4b401b.10ecb","name":"","group":"1c2f0814.027af8","order":2,"width":0,"height":0,"passthru":false,"label":"펌프작동","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"topic","topicType":"msg","x":1000,"y":1120,"wires":[["98288f2a.1d46e"]]},{"id":"83f13102.f42a","type":"ui_button","z":"bd4b401b.10ecb","name":"","group":"1c2f0814.027af8","order":2,"width":0,"height":0,"passthru":false,"label":"유량초기화","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"topic","topicType":"msg","x":990,"y":1180,"wires":[["81e16c4c.fd35d"]]},{"id":"c664f358.117f","type":"function","z":"bd4b401b.10ecb","name":"가상의 노드1번","func":"\n//반대쪽으로 넘길 table 입력값을 만들어준다!\nvar update = {};\nupdate.command = \"updateOrAddData\";\nupdate.arguments = [];\n\nvar argu = [];\nvar dataset = {};\n//dataset.id = socket.record_num; //레코드넘버\ndataset.Device_id = \"#device5\"; \ndataset.Dong = \"하우스2동\";\ndataset.Rssi = -60; //wifi감도\ndataset.Run = 1; //활성상태\ndataset.Up = 200; //업로드데이터량\ndataset.Down = 200; //다운로드데이터량\n\ndataset.Data = [];\n//dataset.Data = [];\n\nargu.push(dataset);\nupdate.arguments.push(argu);\n\nmsg.payload = update;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":100,"wires":[["541afce5.f7bed4"]]},{"id":"60e8f48b.25171c","type":"inject","z":"bd4b401b.10ecb","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":800,"y":100,"wires":[["c664f358.117f","88d432bd.c77e2","77546594.41189c","8231a626.6d5228","311d3389.bff81c","d6fb2ccb.d8c6c"]]},{"id":"88d432bd.c77e2","type":"function","z":"bd4b401b.10ecb","name":"가상의 노드2번","func":"\n//반대쪽으로 넘길 table 입력값을 만들어준다!\nvar update = {};\nupdate.command = \"updateOrAddData\";\nupdate.arguments = [];\n\nvar argu = [];\nvar dataset = {};\n//dataset.id = socket.record_num; //레코드넘버\ndataset.Device_id = \"#device6\"; \ndataset.Dong = \"하우스2동\";\ndataset.Rssi = -60; //wifi감도\ndataset.Run = 1; //활성상태\ndataset.Up = 200; //업로드데이터량\ndataset.Down = 200; //다운로드데이터량\n\ndataset.Data = [];\n//dataset.Data = [];\n\nargu.push(dataset);\nupdate.arguments.push(argu);\n\nmsg.payload = update;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":140,"wires":[["541afce5.f7bed4"]]},{"id":"77546594.41189c","type":"function","z":"bd4b401b.10ecb","name":"가상의 노드3번","func":"\n//반대쪽으로 넘길 table 입력값을 만들어준다!\nvar update = {};\nupdate.command = \"updateOrAddData\";\nupdate.arguments = [];\n\nvar argu = [];\nvar dataset = {};\n//dataset.id = socket.record_num; //레코드넘버\ndataset.Device_id = \"#device6\"; \ndataset.Dong = \"하우스1동\";\ndataset.Rssi = -60; //wifi감도\ndataset.Run = 1; //활성상태\ndataset.Up = 200; //업로드데이터량\ndataset.Down = 200; //다운로드데이터량\n\ndataset.Data = [];\n//dataset.Data = [];\n\nargu.push(dataset);\nupdate.arguments.push(argu);\n\nmsg.payload = update;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":180,"wires":[["541afce5.f7bed4"]]},{"id":"8231a626.6d5228","type":"function","z":"bd4b401b.10ecb","name":"가상의 노드4번","func":"\n//반대쪽으로 넘길 table 입력값을 만들어준다!\nvar update = {};\nupdate.command = \"updateOrAddData\";\nupdate.arguments = [];\n\nvar argu = [];\nvar dataset = {};\n//dataset.id = socket.record_num; //레코드넘버\ndataset.Device_id = \"#device6\"; \ndataset.Dong = \"하우스1동\";\ndataset.Rssi = -60; //wifi감도\ndataset.Run = 1; //활성상태\ndataset.Up = 200; //업로드데이터량\ndataset.Down = 200; //다운로드데이터량\n\ndataset.Data = [];\n//dataset.Data = [];\n\nargu.push(dataset);\nupdate.arguments.push(argu);\n\nmsg.payload = update;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":220,"wires":[["541afce5.f7bed4"]]},{"id":"311d3389.bff81c","type":"function","z":"bd4b401b.10ecb","name":"가상의 노드5번","func":"\n//반대쪽으로 넘길 table 입력값을 만들어준다!\nvar update = {};\nupdate.command = \"updateOrAddData\";\nupdate.arguments = [];\n\nvar argu = [];\nvar dataset = {};\n//dataset.id = socket.record_num; //레코드넘버\ndataset.Device_id = \"#device6\"; \ndataset.Dong = \"하우스3동\";\ndataset.Rssi = -60; //wifi감도\ndataset.Run = 1; //활성상태\ndataset.Up = 200; //업로드데이터량\ndataset.Down = 200; //다운로드데이터량\n\ndataset.Data = [];\n//dataset.Data = [];\n\nargu.push(dataset);\nupdate.arguments.push(argu);\n\nmsg.payload = update;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":260,"wires":[["541afce5.f7bed4"]]},{"id":"d6fb2ccb.d8c6c","type":"function","z":"bd4b401b.10ecb","name":"가상의 노드6번","func":"\n//반대쪽으로 넘길 table 입력값을 만들어준다!\nvar update = {};\nupdate.command = \"updateOrAddData\";\nupdate.arguments = [];\n\nvar argu = [];\nvar dataset = {};\n//dataset.id = socket.record_num; //레코드넘버\ndataset.Device_id = \"#device6\"; \ndataset.Dong = \"하우스3동\";\ndataset.Rssi = -60; //wifi감도\ndataset.Run = 1; //활성상태\ndataset.Up = 200; //업로드데이터량\ndataset.Down = 200; //다운로드데이터량\n\ndataset.Data = [];\n//dataset.Data = [];\n\nargu.push(dataset);\nupdate.arguments.push(argu);\n\nmsg.payload = update;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":300,"wires":[["541afce5.f7bed4"]]},{"id":"aa2634f1.1bbfd8","type":"ui_group","name":"클라이언트리스트","tab":"d25c9cdc.bf5cd","order":1,"disp":true,"width":"6","collapse":false,"className":""},{"id":"9c2bb4e6.01d708","type":"ui_group","name":"서버정보","tab":"d25c9cdc.bf5cd","order":2,"disp":true,"width":"6","collapse":false,"className":""},{"id":"4ac94e5d.efbcd","type":"ui_group","name":"클라이언트정보","tab":"d25c9cdc.bf5cd","order":3,"disp":true,"width":"6","collapse":false,"className":""},{"id":"832145a9.25bca8","type":"ui_group","name":"디바이스정보","tab":"23e9519c.96172e","order":1,"disp":false,"width":"25","collapse":false,"className":""},{"id":"1c2f0814.027af8","type":"ui_group","name":"펌프노드제어(#device3)","tab":"23e9519c.96172e","order":2,"disp":true,"width":"6","collapse":false,"className":""},{"id":"d25c9cdc.bf5cd","type":"ui_tab","name":"서버정보","icon":"info","order":1,"disabled":false,"hidden":false},{"id":"23e9519c.96172e","type":"ui_tab","name":"컨트롤패널","icon":"tv","order":2,"disabled":false,"hidden":false}]